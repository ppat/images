---
# yamllint disable rule:line-length
name: scan-image

# yamllint disable-line rule:truthy
on:
  pull_request:
    paths:
    - '.github/workflows/scan-image.yaml'
  schedule:
  - cron: '0 10 */30 * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  scan-image:
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image:
        - bitwarden-cli
        - freeradius-server
    timeout-minutes: 10

    steps:
    - name: Run Trivy vulnerability scanner (non-publish workflow runs only)
      uses: aquasecurity/trivy-action@6e7b7d1fd3e4fef0c5fa8cce1229c54b2c9bd0d8 # 0.24.0
      with:
        image-ref: docker.io/ppatlabs/${{ matrix.image }}:latest
        scan-type: image
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: "MEDIUM,HIGH,CRITICAL"
        scanners: "vuln"

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@6a89f57882288b3d2f190cda65000eec9e9ebb7c # v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
