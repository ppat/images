---
# yamllint disable rule:line-length
name: scan-image

# yamllint disable-line rule:truthy
on:
  pull_request:
    paths:
    - '.github/workflows/scan-image.yaml'
  schedule:
  - cron: '0 10 */30 * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  scan-image:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image:
        - bitwarden-cli
        - freeradius-server
    timeout-minutes: 10

    steps:
    - name: Tailscale Connect
      uses: tailscale/github-action@4e4c49acaa9818630ce0bd7a564372c17e33fb4d # v2
      with:
        oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
        tags: tag:github-action-ci-runner
        # renovate: datasource=github-releases depName=tailscale/tailscale
        version: "1.68.1"

    - name: Run Trivy vulnerability scanner (non-publish workflow runs only)
      uses: aquasecurity/trivy-action@7c2007bcb556501da015201bcba5aa14069b74e2 # 0.23.0
      with:
        image-ref: ${{ secrets.CONTAINER_REGISTRY }}/${{ vars.CONTAINER_REGISTRY_PATH }}/${{ matrix.image }}:latest
        scan-type: image
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: "MEDIUM,HIGH,CRITICAL"
        scanners: "vuln"
      env:
        TRIVY_USERNAME: ${{ secrets.CONTAINER_REGISTRY_USERNAME }}
        TRIVY_PASSWORD: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Tailscale Disconnect
      if: ${{ success() || failure() }}
      run: sudo -E tailscale logout
